<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Graph</title>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
	<script type="text/javascript" src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
	<style>
		.chart-container {
			width: 90vw;
			height: 90vh;
		}
	</style>
</head>
<body>
	<div class="chart-container">
		<canvas id="chart"></canvas>
	</div>
</body>
</html>
<script type="text/javascript">

const CURRENCY = "CZK"
const ctx = document.getElementById('chart');
// ?ids[]=tesco%2F2001019141652.csv&ids[]=tesco%2F2001130909583.csv&ids[]=tesco%2F2001000151875.csv&ids[]=tesco%2F2001130898559.csv&ids[]=tesco%2F2001130294293.csv&ids[]=tesco%2F2001130907487.csv&ids[]=tesco%2F2001130294254.csv&ids[]=tesco%2F2001130905057.csv&ids[]=tesco%2F2001130905063.csv&ids[]=tesco%2F2001130905073.csv&ids[]=albert%2F20480905.csv&ids[]=albert%2F22459466.csv&ids[]=albert%2F27344064.csv&ids[]=albert%2F26109718.csv&ids[]=albert%2F21976056.csv&ids[]=billa%2F82322229.csv&ids[]=billa%2F82316363.csv&ids[]=billa%2F82315094.csv
const params = new URLSearchParams(window.location.search);

async function getDataset(path) {
	// This doesn't seem safe
	csvData = await fetch("data/" + path).then(response => response.text());
	
	var parsed = Papa.parse(csvData, {
		header: true,
		skipEmptyLines: true,
		dynamicTyping: {"timestamp": true, "price": true, "unit_price": true},
		transform: function(value, field) {
			// Rounding to an hour
			if (field === 'timestamp') return (value-value%3600) * 1000;
			return value;
		},
	});
	
	let o = Object.assign({}, parsed.data[0]);

	for (let i = 0; i < parsed.data.length; i++) {
		parsed.meta.fields.forEach(j => {
			if (!parsed.data[i][j]) parsed.data[i][j] = o[j];
			else o[j] = parsed.data[i][j];
		});
	}

	return {
		label: `${parsed.data[0].store} – ${parsed.data[parsed.data.length-1].name}`,
		data: parsed.data,
	};
}


async function main() {
	var d = await Promise.all(params.getAll("ids[]").map(async (path) => {
		console.log(path)
		return await getDataset(path);
	}));

	const priceChart = new Chart(ctx, {
		type: 'line',
		data: {
			datasets: d,
		},
		options: {
			// Performance
			animation: false,
			parsing: false,

			responsive: true,
			plugins: {
				tooltip: {
					callbacks: {
						label: function(context) {
							let i = context.element.$context.raw
							return `${i.price}${CURRENCY} – ${i.store} – ${i.name}`;
						}
					}
				}
			},
			parsing: {
				xAxisKey: 'timestamp',
				yAxisKey: 'price',
			},
			scales: {
				x: {
					type: 'time',
					time: {
						unit: "day",
					},
				},
				y: {
					beginAtZero: true,
				}
			}
		}
	});


}

main();

</script>